#!/bin/bash

# Talos GCP Deployment Script
# Based on: https://docs.siderolabs.com/talos/v1.12/platform-specific-installations/cloud-platforms/gcp

#set -x
echo "DEBUG: Script Started"
set -euo pipefail

# Configuration
SCRIPT_DIR="$(dirname "$0")"
source "${SCRIPT_DIR}/lib/utils.sh"

CONFIG_FILE=""
ARGS=()

# Parse early arguments for config file
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--config)
            if [ -n "${2:-}" ]; then
                CONFIG_FILE="$2"
                shift 2
            else
                echo "Error: --config requires a file argument."
                exit 1
            fi
            ;;
        --config=*)
            CONFIG_FILE="${1#*=}"
            shift
            ;;
        -h|--help)
            # Source help library if available for global help, or defer to usage
            # We defer to check dependencies or direct source
            source "$(dirname "$0")/lib/help.sh"
            show_help
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Restore positional parameters (removing -c/--config)
set -- "${ARGS[@]}"

# Load Config if specified
if [ -n "$CONFIG_FILE" ]; then
    if [ -f "$CONFIG_FILE" ]; then
        echo "Loading config from $CONFIG_FILE..."
        source "$CONFIG_FILE"
    else
        echo "Error: Config file $CONFIG_FILE not found."
        exit 1
    fi
else
    # Try default cluster.env if it exists
    if [ -f "cluster.env" ]; then
        echo "Loading default config from cluster.env..."
        source "cluster.env"
    fi
fi

# Configuration
export CLOUDSDK_CORE_DISABLE_PROMPTS=1

# Detect Project ID
# Use configured value if set, otherwise auto-detect
if [ -z "${PROJECT_ID:-}" ]; then
    PROJECT_ID=$(gcloud config get-value project 2>/dev/null)
fi

if [ -z "${PROJECT_ID:-}" ]; then
    error "No GCP Project ID found."
    error "Please run: gcloud config set project YOUR_PROJECT_ID"
    error "Or set PROJECT_ID in config/env."
    exit 1
fi

REGION=${REGION:-"us-central1"}
ZONE=${ZONE:-"${REGION}-b"}

# Import Libraries (Order matters for overrides/defaults)
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/network.sh"
source "${SCRIPT_DIR}/lib/bastion.sh"
source "${SCRIPT_DIR}/lib/controlplane.sh"
source "${SCRIPT_DIR}/lib/workers.sh"
source "${SCRIPT_DIR}/lib/cni.sh"

# New Libraries
source "${SCRIPT_DIR}/lib/images.sh"
source "${SCRIPT_DIR}/lib/bootstrap.sh"
source "${SCRIPT_DIR}/lib/lifecycle.sh"
source "${SCRIPT_DIR}/lib/ops.sh"
source "${SCRIPT_DIR}/lib/traefik.sh"
source "${SCRIPT_DIR}/lib/orphans.sh"
source "${SCRIPT_DIR}/lib/access.sh"
source "${SCRIPT_DIR}/lib/help.sh"

# Call immediately to set defaults for global scope
# set_names  <-- Removed global call to prevent side effects. Explicitly called in local functions.

# --- Main Interaction ---

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

COMMAND="$1"

case "$COMMAND" in
    create)
        deploy_all
        ;;
    destroy)
        # check_dependencies - Not needed
        cleanup
        ;;
    status)
        set_names
        # check_dependencies - Not needed
        status
        ;;
    diagnose)
        set_names
        # check_dependencies - Not needed
        diagnose
        ;;
    list-clusters|list)
        set_names
        # check_dependencies - Not needed
        list_clusters
        ;;
    ssh|ssh-bastion)
        shift
        set_names
        # check_dependencies - Not needed
        ensure_admin_access # Ensure we have rights to login
        ssh_command "$@"
        ;;
    get-credentials)
        set_names
        check_dependencies
        get_credentials
        ;;
    update-cilium)
        set_names
        check_dependencies
        update_cilium
        ;;
    list-instances)
        set_names
        # check_dependencies - Not needed, only uses gcloud
        list_instances
        ;;
    list-ports)
        set_names
        # check_dependencies - Not needed
        list_ports
        ;;
    update-ports)
        set_names
        # check_dependencies - Not needed
        update_ports
        ;;
    public-ip)
        set_names
        # check_dependencies - Not needed
        public_ip
        ;;
    # bastion-user commands removed in favor of Pure IAM.
    # See 'grant-admin' and 'recreate-bastion'.
    apply)
        if [[ "${2:-}" == "-y" ]] || [[ "${2:-}" == "--yes" ]]; then
            export CONFIRM_CHANGES="false"
            shift
        fi
        apply
        ;;

    recreate-bastion)
        set_names
        check_dependencies || return 1
        ensure_service_account || return 1
        ensure_admin_access # Ensure we have rights to login to the new one
        
        log "Recreating Bastion Host '${BASTION_NAME}'..."
        
        if gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --project="${PROJECT_ID}" &> /dev/null; then
            log "Deleting existing bastion..."
            run_safe gcloud compute instances delete "${BASTION_NAME}" --zone "${ZONE}" --project="${PROJECT_ID}" --quiet
        fi
        
        # Re-run Phase 2b and Phase 4
        phase2_bastion
        phase4_bastion
        
        log "Bastion recreated successfully."
        ;;

    grant-admin)
        set_names
        check_dependencies || return 1
        if [ -z "${2:-}" ]; then
            error "Usage: ./talos-gcp grant-admin <email>"
            error "Example: ./talos-gcp grant-admin user@example.com"
            exit 1
        fi
        EMAIL="$2"
        log "Granting Admin Access to '${EMAIL}'..."
        
        # 1. OS Admin Login (Root)
        log "  -> Adding 'roles/compute.osAdminLogin' (Root Access)..."
        run_safe gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/compute.osAdminLogin" >/dev/null

        # 2. IAP Tunnel Access (Often implicitly held by project owners, but explicit is safer)
        log "  -> Adding 'roles/iap.tunnelResourceAccessor' (Tunnel Access)..."
        run_safe gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/iap.tunnelResourceAccessor" >/dev/null

        # 3. GCS Bucket Access
        log "  -> Granting read access to bucket 'gs://${BUCKET_NAME}'..."
        run_safe gsutil iam ch "user:${EMAIL}:objectViewer" "gs://${BUCKET_NAME}"

        # 4. Service Account User (Required for OS Login on VM with SA)
        # Fetch actual SA from Bastion (it uses Default Compute SA usually)
        log "  -> resolving Bastion Service Account..."
        local ACTUAL_SA
        ACTUAL_SA=$(gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --format="value(serviceAccounts[0].email)" --project="${PROJECT_ID}" 2>/dev/null)
        
        if [ -n "${ACTUAL_SA}" ]; then
            log "  -> Granting 'roles/iam.serviceAccountUser' on '${ACTUAL_SA}'..."
            run_safe gcloud iam service-accounts add-iam-policy-binding "${ACTUAL_SA}" \
                --member="user:${EMAIL}" \
                --role="roles/iam.serviceAccountUser" >/dev/null
        else
            warn "Could not determine Bastion Service Account. Skipping 'serviceAccountUser' role."
        fi

        log "Admin access granted."
        ;;

    grant-access)
        set_names
        check_dependencies || return 1
        
        if [ -z "${2:-}" ]; then
            error "Usage: ./talos-gcp grant-access <email>"
            error "Example: ./talos-gcp grant-access dev@example.com"
            exit 1
        fi
        EMAIL="$2"
        log "Granting Developer Access to '${EMAIL}'..."
        
        # 1. OS Login (Non-Admin) - Allows SSH Key management & Instance Get
        log "  -> Adding 'roles/compute.osLogin' (Instance Access)..."
        run_safe gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/compute.osLogin" >/dev/null

        # 2. IAP Tunnel Access - Required for --tunnel-through-iap
        log "  -> Adding 'roles/iap.tunnelResourceAccessor' (Tunnel Access)..."
        run_safe gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/iap.tunnelResourceAccessor" >/dev/null
            
        # 3. GCS Bucket Access - Allow fetching credentials
        log "  -> Granting read access to bucket 'gs://${BUCKET_NAME}'..."
        run_safe gsutil iam ch "user:${EMAIL}:objectViewer" "gs://${BUCKET_NAME}"
        
        # 4. Service Account User (Required for OS Login on VM with SA)
        log "  -> resolving Bastion Service Account..."
        local ACTUAL_SA
        ACTUAL_SA=$(gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --format="value(serviceAccounts[0].email)" --project="${PROJECT_ID}" 2>/dev/null)

        if [ -n "${ACTUAL_SA}" ]; then
            log "  -> Granting 'roles/iam.serviceAccountUser' on '${ACTUAL_SA}'..."
            run_safe gcloud iam service-accounts add-iam-policy-binding "${ACTUAL_SA}" \
                --member="user:${EMAIL}" \
                --role="roles/iam.serviceAccountUser" >/dev/null
             log "Developer access granted (SSH + IAP + GCS + SA User)."
        else
             warn "Could not determine Bastion Service Account. Skipping 'serviceAccountUser' role."
             log "Developer access granted (SSH + IAP + GCS)."
        fi
        
        log "Ask the user to run:"
        log "  1. ./talos-gcp get-credentials"
        log "  2. ./talos-gcp access-info"
        ;;

    list-access)
        set_names
        check_dependencies
        log "Listing users by role..."
        
        echo "=== [Admin] roles/compute.osAdminLogin ==="
        gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/compute.osAdminLogin" \
            --format="value(bindings.members)" || true

        echo ""
        echo "=== [Developer] roles/compute.osLogin ==="
        gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/compute.osLogin" \
            --format="value(bindings.members)" || true
            
        echo ""
        echo "=== [Tunnel] roles/iap.tunnelResourceAccessor ==="
        gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/iap.tunnelResourceAccessor" \
            --format="value(bindings.members)" || true
        
        echo ""
        echo "=== [GCS] Storage Object Viewers (${BUCKET_NAME}) ==="
        gsutil iam get "gs://${BUCKET_NAME}" | grep "user:" || echo "No explicit user bindings found on bucket."
        
        echo ""
        # Resolve SA for listing
        local ACTUAL_SA
        ACTUAL_SA=$(gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --format="value(serviceAccounts[0].email)" --project="${PROJECT_ID}" 2>/dev/null)
        if [ -n "${ACTUAL_SA}" ]; then
            echo "=== [SA User] roles/iam.serviceAccountUser (${ACTUAL_SA}) ==="
            gcloud iam service-accounts get-iam-policy "${ACTUAL_SA}" \
                --flatten="bindings[].members" \
                --filter="bindings.role:roles/iam.serviceAccountUser" \
                --format="value(bindings.members)" || true
        else
            echo "=== [SA User] (Bastion SA not found) ==="
        fi
        ;;
        
    revoke-access)
        set_names
        check_dependencies || return 1
        
        if [ -z "${2:-}" ]; then
            error "Usage: ./talos-gcp revoke-access <email>"
            error "Example: ./talos-gcp revoke-access dev@example.com"
            exit 1
        fi
        EMAIL="$2"
        log "Revoking access for '${EMAIL}'..."
        
        # Check if user is an Admin first
        if gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/compute.osAdminLogin" \
            --format="value(bindings.members)" | grep -q "user:${EMAIL}"; then
            echo ""
            echo -e "${RED}[WARNING] User '${EMAIL}' has Admin Access (roles/compute.osAdminLogin)!${NC}"
            echo "Revoking developer roles will NOT fully remove their access."
            echo "To remove Admin access, you must manually run:"
            echo "  gcloud projects remove-iam-policy-binding ${PROJECT_ID} --member=user:${EMAIL} --role=roles/compute.osAdminLogin"
            echo ""
            echo -n "Continue checking/removing developer roles? [y/N] "
            read -r response
            if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
                log "Aborted."
                exit 0
            fi
        fi

        # 1. OS Login (Non-Admin)
        log "  -> Removing 'roles/compute.osLogin'..."
        run_safe gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/compute.osLogin" >/dev/null || warn "Role not found or already removed."

        # 2. IAP Tunnel Access
        log "  -> Removing 'roles/iap.tunnelResourceAccessor'..."
        run_safe gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
            --member="user:${EMAIL}" \
            --role="roles/iap.tunnelResourceAccessor" >/dev/null || warn "Role not found or already removed."

        # 3. GCS Bucket Access
        log "  -> Removing read access from bucket 'gs://${BUCKET_NAME}'..."
        if gsutil iam ch -d "user:${EMAIL}:objectViewer" "gs://${BUCKET_NAME}"; then
             :
        else
             warn "Failed to remove bucket access (or not present)."
        fi
        
        # 4. Service Account User
        log "  -> resolving Bastion Service Account..."
        local ACTUAL_SA
        ACTUAL_SA=$(gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --format="value(serviceAccounts[0].email)" --project="${PROJECT_ID}" 2>/dev/null)

        if [ -n "${ACTUAL_SA}" ]; then
            log "  -> Removing 'roles/iam.serviceAccountUser' from '${ACTUAL_SA}'..."
            run_safe gcloud iam service-accounts remove-iam-policy-binding "${ACTUAL_SA}" \
                --member="user:${EMAIL}" \
                --role="roles/iam.serviceAccountUser" >/dev/null || warn "Role not found or already removed."
        else
            warn "Could not determine Bastion Service Account. Skipping 'serviceAccountUser' cleanup."
        fi
        
        log "Access revoked."
        ;;

    list-admins)
        set_names
        log "Listing users with 'roles/compute.osAdminLogin' (Bastion Admins)..."
        gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/compute.osAdminLogin" \
            --format="value(bindings.members)" || echo "No admins found or error listing policy."
        ;;

    verify-storage)
        set_names
        check_dependencies
        verify_storage
        ;;
    update-labels)
        set_names
        check_dependencies
        update_labels
        ;;
    update-traefik)
        set_names
        check_dependencies
        update_traefik
        ;;
    orphans)
        set_names
        check_dependencies
        if [[ "${2:-}" == "clean" ]] || [[ "${2:-}" == "cleanup" ]]; then
             cleanup_orphans
        else
             list_orphans
        fi
        ;;
    access-info)
        set_names
        # check_dependencies - Not needed
        access_info
        ;;
    start)
        # check_dependencies - Not needed
        start_nodes
        ;;
    stop)
        # check_dependencies - Not needed
        stop_nodes
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $COMMAND"
        usage
        exit 1
        ;;
esac
