#!/bin/bash

# Talos GCP Deployment Script
# Based on: https://docs.siderolabs.com/talos/v1.12/platform-specific-installations/cloud-platforms/gcp

#set -x

set -euo pipefail

# Configuration
SCRIPT_DIR="$(dirname "$0")"
source "${SCRIPT_DIR}/lib/utils.sh"

CONFIG_FILE="${TALOS_GCP_CONFIG:-}"
ARGS=()

# Parse early arguments for config file
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--config)
            if [ -n "${2:-}" ]; then
                CONFIG_FILE="$2"
                shift 2
            else
                echo "Error: --config requires a file argument."
                exit 1
            fi
            ;;
        --config=*)
            CONFIG_FILE="${1#*=}"
            shift
            ;;
        -h|--help)
            # Source help library if available for global help, or defer to usage
            # We defer to check dependencies or direct source
            source "$(dirname "$0")/lib/help.sh"
            show_help
            exit 0
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Restore positional parameters (removing -c/--config)
set -- "${ARGS[@]}"

# Load Config if specified
if [ -n "$CONFIG_FILE" ]; then
    if [ -f "$CONFIG_FILE" ]; then
        echo "Loading config from $CONFIG_FILE..."
        source "$CONFIG_FILE"
    else
        echo "Error: Config file $CONFIG_FILE not found."
        exit 1
    fi
else
    # Try default cluster.env if it exists
    if [ -f "cluster.env" ]; then
        echo "Loading default config from cluster.env..."
        source "cluster.env"
    fi
fi

# Configuration
export CLOUDSDK_CORE_DISABLE_PROMPTS=1

# Detect Project ID
# Use configured value if set, otherwise auto-detect
if [ -z "${PROJECT_ID:-}" ]; then
    PROJECT_ID=$(gcloud config get-value project 2>/dev/null)
fi

if [ -z "${PROJECT_ID:-}" ]; then
    error "No GCP Project ID found."
    error "Please run: gcloud config set project YOUR_PROJECT_ID"
    error "Or set PROJECT_ID in config/env."
    exit 1
fi

REGION=${REGION:-"us-central1"}
ZONE=${ZONE:-"${REGION}-b"}

# Import Libraries (Order matters for overrides/defaults)
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/network.sh"
source "${SCRIPT_DIR}/lib/bastion.sh"
source "${SCRIPT_DIR}/lib/controlplane.sh"
source "${SCRIPT_DIR}/lib/workers.sh"
source "${SCRIPT_DIR}/lib/cni.sh"

# New Libraries
source "${SCRIPT_DIR}/lib/images.sh"
source "${SCRIPT_DIR}/lib/bootstrap.sh"
source "${SCRIPT_DIR}/lib/lifecycle.sh"
source "${SCRIPT_DIR}/lib/ops.sh"
source "${SCRIPT_DIR}/lib/schedule.sh"
source "${SCRIPT_DIR}/lib/traefik.sh"
source "${SCRIPT_DIR}/lib/orphans.sh"
source "${SCRIPT_DIR}/lib/access.sh"
source "${SCRIPT_DIR}/lib/binaries.sh"

source "${SCRIPT_DIR}/lib/help.sh"

# Call immediately to set defaults for global scope
# set_names  <-- Removed global call to prevent side effects. Explicitly called in local functions.

# --- Main Interaction ---

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

COMMAND="$1"

case "$COMMAND" in
    create)
        check_dependencies
        # Ensure tools
        export TALOSCTL=$(ensure_tool "talosctl" "${TALOS_VERSION}")
        export KUBECTL=$(ensure_tool "kubectl" "${KUBECTL_VERSION}")
        
        check_quotas
        deploy_all
        ;;
    destroy)
        if [[ "${2:-}" == "-y" ]] || [[ "${2:-}" == "--yes" ]]; then
            export CONFIRM_CHANGES="false"
            shift
        fi
        # check_dependencies - Not needed
        cleanup
        ;;
    status)
        set_names
        # check_dependencies - Not needed
        status
        ;;
    diagnose)
        set_names
        # check_dependencies - Not needed
        diagnose
        ;;
    list-clusters|list)
        set_names
        # check_dependencies - Not needed
        list_clusters
        ;;
    ssh|ssh-bastion)
        shift
        set_names
        # check_dependencies - Not needed
        ensure_admin_access # Ensure we have rights to login
        ssh_command "$@"
        ;;
    get-credentials)
        set_names
        check_dependencies
        export TALOSCTL=$(ensure_tool "talosctl" "${TALOS_VERSION}")
        get_credentials
        ;;
    update-cilium)
        set_names
        check_dependencies
        update_cilium
        ;;
    list-instances)
        set_names
        # check_dependencies - Not needed, only uses gcloud
        list_instances
        ;;
    list-ports)
        set_names
        # check_dependencies - Not needed
        list_ports
        ;;
    update-ports)
        set_names
        # check_dependencies - Not needed
        update_ports
        ;;
    public-ip)
        set_names
        # check_dependencies - Not needed
        public_ip
        ;;
    # bastion-user commands removed in favor of Pure IAM.
    # See 'grant-admin' and 'recreate-bastion'.
    apply)
        if [[ "${2:-}" == "-y" ]] || [[ "${2:-}" == "--yes" ]]; then
            export CONFIRM_CHANGES="false"
            shift
        fi
        check_dependencies
        check_quotas
        export TALOSCTL=$(ensure_tool "talosctl" "${TALOS_VERSION}")
        export KUBECTL=$(ensure_tool "kubectl" "${KUBECTL_VERSION}")
        apply
        ;;

    recreate-bastion)
        set_names
        check_dependencies || return 1

        ensure_service_account || return 1
        ensure_admin_access # Ensure we have rights to login to the new one
        
        log "Recreating Bastion Host '${BASTION_NAME}'..."
        
        if gcloud compute instances describe "${BASTION_NAME}" --zone "${ZONE}" --project="${PROJECT_ID}" &> /dev/null; then
            log "Deleting existing bastion..."
            run_safe gcloud compute instances delete "${BASTION_NAME}" --zone "${ZONE}" --project="${PROJECT_ID}" --quiet
        fi
        
        # Re-run Phase 2b and Phase 4
        phase2_bastion
        phase4_bastion
        
        log "Bastion recreated successfully."
        ;;

    grant-admin)
        shift
        cmd_grant_admin "$@"
        ;;

    grant-access)
        shift
        cmd_grant_access "$@"
        ;;

    list-access)
        shift
        cmd_list_access "$@"
        ;;
        
    revoke-access)
        shift
        cmd_revoke_access "$@"
        ;;

    list-admins)
        set_names
        log "Listing users with 'roles/compute.osAdminLogin' (Bastion Admins)..."
        gcloud projects get-iam-policy "${PROJECT_ID}" \
            --flatten="bindings[].members" \
            --filter="bindings.role:roles/compute.osAdminLogin" \
            --format="value(bindings.members)" || echo "No admins found or error listing policy."
        ;;

    verify-storage)
        set_names
        check_dependencies
        verify_storage
        ;;
    verify-connectivity)
        set_names
        check_dependencies
        verify_connectivity
        ;;
    update-labels)
        set_names
        check_dependencies
        update_labels
        ;;
    update-traefik)
        set_names
        check_dependencies
        update_traefik
        ;;
    update-schedule)
        set_names
        check_dependencies
        update_schedule
        ;;
    orphans)
        set_names
        check_dependencies
        if [[ "${2:-}" == "clean" ]] || [[ "${2:-}" == "cleanup" ]]; then
             cleanup_orphans
        else
             list_orphans
        fi
        ;;
    access-info)
        set_names
        # check_dependencies - Not needed
        access_info
        ;;
    verify-access)
        set_names
        check_dependencies
        shift
        verify_access "$@"
        ;;
    start)
        shift
        # check_dependencies - Not needed
        start_nodes "$@"
        ;;
    stop)
        shift
        # check_dependencies - Not needed
        stop_nodes "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $COMMAND"
        usage
        exit 1
        ;;
esac
